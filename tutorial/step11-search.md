# Шаг 11: Функции NetBox v3.4

В NetBox версии 3.4, выпущенной в декабре 2022 года, была представлена ​​значительно улучшенная глобальная поисковая система, которая включает возможность для плагинов регистрировать свои собственные модели. На этом шаге мы добавим индексаторы поиска для наших пользовательских моделей, чтобы они отображались в глобальных результатах поиска NetBox.

:warning: **Предупреждение:** Для этой функции требуется NetBox v3.4 или более поздняя версия. Если вы еще этого не сделали, обязательно установите `min_version = '3.4.0'` в `NetBoxAccessListsConfig`.

:blue_square: **Примечание:** Если вы пропустили предыдущий шаг, запустите `git checkout step10-graphql`.

## Создание поисковых индексов

В нашем плагине есть две модели: `AccessList` и `AccessListRule`. Мы хотели бы, чтобы пользователи могли искать экземпляры обеих моделей с помощью функции глобального поиска NetBox. Чтобы включить это, нам нужно объявить и зарегистрировать подкласс `SearchIndex` для каждой модели.

Начните с создания `search.py` в корневом каталоге плагина, рядом с `models.py`.

```bash
$ cd netbox_access_lists/
$ edit search.py
```

В этом файле мы импортируем класс `SearchIndex` NetBox, а также наши собственные модели. Затем мы создадим подкласс `SearchIndex` для каждой модели:

```python
from netbox.search import SearchIndex
from .models import AccessList, AccessListRule

class AccessListIndex(SearchIndex):
    model = AccessList

class AccessListRuleIndex(SearchIndex):
    model = AccessListRule
```

Однако включение поиска требует немного больше. Нам также нужно сообщить NetBox, какие поля искать для каждой модели и насколько важно каждое поле (также известно как его _приоритет_). Последнее достигается путем назначения числового веса.

Рассмотрим нашу модель `AccessList`. Она имеет три интересных поля базы данных: `name`, `default_action` и `comments`. Как нам следует обращаться с ними при поиске объектов в NetBox? Это может быть несколько субъективно, но обычно мы хотим назначать более высокий приоритет (_более_ низкие веса) важным полям и пропускать поля, которые нам не нужны. Если вы не уверены, какие веса назначать, посмотрите на основную кодовую базу NetBox для похожих примеров.

* `name`: Это важное поле, поэтому мы дадим ему высокий приоритет `100`.
* `default_action` Это поле выбора. Хотя оно очень полезно для _фильтрации_, мы обычно не ожидаем, что пользователи будут искать эти значения. Мы исключим это поле из индекса поиска.
* `comments`: Всегда рекомендуется включать комментарии пользователей в индекс поиска, однако мы назначим этому полю гораздо более низкий приоритет `5000`, поскольку любые совпадения вряд ли будут релевантными.

После выбора полей поиска и их приоритетов у нас должно получиться что-то вроде этого:

```python
class AccessListIndex(SearchIndex):
    model = AccessList
    fields = (
        ('name', 100),
        ('comments', 5000),
    )

class AccessListRuleIndex(SearchIndex):
    model = AccessListRule
    fields = (
        ('description', 500),
    )
```

Почему мы исключили параметры источника и назначения из `AccessListRuleIndex`? Префиксы источника и назначения являются связанными объектами, поэтому мы хотим избежать локального кэширования их значений: если связанный объект изменится, наша кэшированная копия может устареть. И мы опускаем номера портов источника и назначения, потому что сопоставление общих целочисленных значений может привести к массе нерелевантных результатов поиска. Все эти значения лучше сопоставляются с использованием специальных фильтров, а не поиска общего назначения.

## Регистрация индексаторов

Наконец, нам нужно зарегистрировать наши индексаторы, чтобы NetBox знал, что их нужно запускать. В верхней части `search.py` импортируйте декоратор `register_search`. Затем используйте его для обертывания обоих наших классов индекса:

```python
from netbox.search import SearchIndex, register_search
from .models import AccessList, AccessListRule

@register_search
class AccessListIndex(SearchIndex):
    model = AccessList
    fields = (
        ('name', 100),
        ('comments', 5000),
    )

@register_search
class AccessListRuleIndex(SearchIndex):
    model = AccessListRule
    fields = (
        ('description', 500),
    )
```

Теперь, когда наши индексаторы зарегистрированы, мы можем запустить команду управления `reindex` для индексации любых существующих объектов. (Новые объекты, созданные с этого момента, будут автоматически регистрироваться при создании.)

```
$ ./manage.py reindex netbox_access_lists
Reindexing 2 models.
Indexing models
  netbox_access_lists.accesslist... 1 entries cached.
  netbox_access_lists.accesslistrule... 3 entries cached.
```

Теперь мы можем искать списки доступа и правила, используя функцию глобального поиска NetBox.

![Результаты поиска](/images/step11-search-results.png)

<div align="center">

:arrow_left: [Шаг 10: API GraphQL](/tutorial/step10-graphql-api.md)

</div>